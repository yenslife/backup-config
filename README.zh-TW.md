# ğŸ§© Config Backup Script - çµ„æ…‹æª”å‚™ä»½è…³æœ¬

é€™æ˜¯ä¸€å€‹è‡ªå‹•åŒ–å‚™ä»½æœå‹™çµ„æ…‹æª”çš„ Shell è…³æœ¬ã€‚å®ƒæœƒè®€å–ä¸€å€‹ YAML è¨­å®šæª”ï¼Œæ ¹æ“šå…¶ä¸­çš„å®šç¾©ï¼Œå°‡æ•£è½åœ¨å„è™•çš„æª”æ¡ˆå’Œè³‡æ–™å¤¾æ”¶é›†èµ·ä¾†ï¼Œä¸¦æ‰“åŒ…æˆä¸€å€‹å¸¶æœ‰æ™‚é–“æˆ³çš„ `.tar.gz` å£“ç¸®æª”ã€‚

æ­¤å·¥å…·éå¸¸é©åˆç³»çµ±ç®¡ç†å“¡ï¼Œæˆ–ä»»ä½•å¸Œæœ›å°‡é‡è¦è¨­å®šæª”å‚™ä»½æµç¨‹ç°¡åŒ–ã€é›†ä¸­ç®¡ç†çš„ä½¿ç”¨è€…ï¼Œä¾‹å¦‚å®šæœŸå‚™ä»½åˆ°å¤–æ¥ç¡¬ç¢Ÿæˆ– NASã€‚

âœ¨ **æ ¸å¿ƒåŠŸèƒ½**

*   **é›†ä¸­å¼è¨­å®š**ï¼šé€éå–®ä¸€ `config_backup.yaml` æª”æ¡ˆï¼Œå³å¯ç®¡ç†æ‰€æœ‰æœå‹™çš„å‚™ä»½ç›®æ¨™ã€‚
*   **å½ˆæ€§çš„è·¯å¾‘å®šç¾©**ï¼šæ”¯æ´å‚™ä»½ä»¥ä¸‹ä¸‰ç¨®é¡å‹ï¼š
    *   å–®ä¸€æª”æ¡ˆ (`config_paths`)ã€‚
    *   æ•´å€‹è³‡æ–™å¤¾ï¼ˆéè¿´å‚™ä»½ï¼‰ (`include_dirs`)ã€‚
    *   ä½¿ç”¨è¬ç”¨å­—å…ƒï¼ˆGlobï¼‰åŒ¹é…æª”æ¡ˆèˆ‡è³‡æ–™å¤¾ (`include_globs`, ä¾‹å¦‚ `*.conf`, `/**/`)ã€‚
*   **è‡ªå‹•åŒ–çµæ§‹**ï¼šè…³æœ¬æœƒè‡ªå‹•åœ¨å£“ç¸®æª”å…§ç‚ºæ¯å€‹æœå‹™å»ºç«‹å°ˆå±¬è³‡æ–™å¤¾ï¼Œçµæ§‹æ¸…æ™°ã€‚
*   **æª”åè¡çªè™•ç†**ï¼šç•¶ä¾†æºä¸åŒä½†æª”åç›¸åŒæ™‚ï¼Œæœƒè‡ªå‹•é™„åŠ é›œæ¹Šå€¼é‡æ–°å‘½åï¼Œé¿å…æª”æ¡ˆè¢«è¦†è“‹ã€‚
*   **ç°¡å–®å¯é **ï¼šä»¥ `bash` æ’°å¯«ï¼Œåƒ…ä¾è³´ `yq`ï¼Œå…·å‚™é«˜å¯æ”œæ€§ä¸”æ˜“æ–¼ç†è§£ã€‚
*   **æ™‚é–“æˆ³å‘½å**ï¼šç”¢ç”Ÿçš„å£“ç¸®æª”æœƒè‡ªå‹•å‘½åç‚º `config_backup_YYYY-MM-DD_HH:MM.tar.gz`ï¼Œæ–¹ä¾¿è­˜åˆ¥ã€‚

---

## ğŸš€ å¿«é€Ÿé–‹å§‹

### **1. å‰ç½®éœ€æ±‚**

æ­¤è…³æœ¬éœ€è¦ `yq` ä¾†è§£æ YAML è¨­å®šæª”ã€‚`yq` æ˜¯ä¸€å€‹è¼•é‡ã€å¯æ”œçš„å‘½ä»¤åˆ— YAML è™•ç†å™¨ã€‚

**å®‰è£ (Linux):**

*   **Debian/Ubuntu:**
    ```bash
    sudo apt-get update && sudo apt-get install -y yq
    ```
*   **RHEL/CentOS/Fedora:**
    ```bash
    sudo yum install -y yq
    ```

### **2. å®‰è£è…³æœ¬**

1.  å°‡è…³æœ¬å…§å®¹å„²å­˜è‡³ `/usr/local/bin/backup_configs.sh`ã€‚
2.  è³¦äºˆè…³æœ¬åŸ·è¡Œæ¬Šé™ï¼š
    ```bash
    sudo chmod +x /usr/local/bin/backup_configs.sh
    ```

### **3. å»ºç«‹è¨­å®šæª”**

å»ºç«‹æ‚¨çš„ YAML è¨­å®šæª”ï¼Œè…³æœ¬é è¨­æœƒè®€å– `/etc/config_backup.yaml`ã€‚

```bash
sudo touch /etc/config_backup.yaml
```

æ¥è‘—ï¼Œç·¨è¼¯é€™å€‹æª”æ¡ˆï¼Œå¡«å…¥æ‚¨çš„å‚™ä»½è¨­å®šã€‚è©³ç´°æ ¼å¼è«‹åƒè€ƒä¸‹æ–¹çš„è¨­å®šæª”èªªæ˜ã€‚

---

## âš™ï¸ è¨­å®šæª” (`config_backup.yaml`)

YAML è¨­å®šæª”å®šç¾©äº†å£“ç¸®æª”çš„è¼¸å‡ºä½ç½®ï¼Œä»¥åŠæ¯å€‹æœå‹™éœ€è¦å‚™ä»½çš„å…·é«”è·¯å¾‘ã€‚

### **æª”æ¡ˆçµæ§‹**

```yaml
# --- å…¨åŸŸè¨­å®š ---

# [å¿…å¡«] æœ€çµ‚ .tar.gz å£“ç¸®æª”çš„å„²å­˜è·¯å¾‘ã€‚
backup_dir: /mnt/backup

# [é¸å¡«] å£“ç¸®æª”å…§æœ€ä¸Šå±¤è³‡æ–™å¤¾çš„åç¨±ã€‚
# è‹¥ç•™ç©ºï¼Œé è¨­ç‚º "config_backup"ã€‚
root_dir_name: my_server_configs

# --- æœå‹™å®šç¾© ---

services:
  # --- æœå‹™ 1ï¼šåƒ…åŒ…å«å¹¾å€‹è¨­å®šæª”çš„ç°¡å–®æœå‹™ ---
  - name: kafka
    # è¦å‚™ä»½çš„ã€Œå–®ä¸€æª”æ¡ˆã€åˆ—è¡¨ã€‚
    config_paths:
      - /etc/kafka/server.properties
      - /etc/kafka/zookeeper.properties

  # --- æœå‹™ 2ï¼šåŒ…å«è³‡æ–™å¤¾èˆ‡è¬ç”¨å­—å…ƒè·¯å¾‘çš„æœå‹™ ---
  - name: nginx
    # ä½ å¯ä»¥æ··åˆä½¿ç”¨ä¸åŒçš„è·¯å¾‘é¡å‹ã€‚
    config_paths:
      - /etc/nginx/nginx.conf
    # éè¿´å‚™ä»½æ­¤è³‡æ–™å¤¾ä¸‹çš„æ‰€æœ‰å…§å®¹ã€‚
    include_dirs:
      - /etc/nginx/conf.d
    # å‚™ä»½ç¬¦åˆ Glob è¬ç”¨å­—å…ƒæ¨¡å¼çš„æª”æ¡ˆæˆ–è³‡æ–™å¤¾ã€‚
    # `**` è¬ç”¨å­—å…ƒå¯å¯¦ç¾éè¿´åŒ¹é…ã€‚
    include_globs:
      - /etc/nginx/sites-enabled/*.conf
      - /opt/myapp/**/config*.yml

  # --- æœå‹™ 3ï¼šåªæœ‰ä¸€å€‹æª”æ¡ˆçš„æœå‹™ ---
  - name: mongodb
    config_paths:
      - /etc/mongod.conf
```

### **è¨­å®šåƒæ•¸èªªæ˜**

| éµå€¼            | é¡å‹   | æ˜¯å¦å¿…å¡« | é è¨­å€¼            | èªªæ˜                                                               |
| --------------- | ------ | -------- | ----------------- | ------------------------------------------------------------------ |
| `backup_dir`    | å­—ä¸²   | æ˜¯       | `/mnt/backup`     | æœ€çµ‚å£“ç¸®æª”çš„å„²å­˜ç›®éŒ„ã€‚                                             |
| `root_dir_name` | å­—ä¸²   | å¦       | `config_backup`   | ç”¢ç”Ÿä¹‹ `.tar.gz` æª”æ¡ˆå…§éƒ¨æœ€ä¸Šå±¤çš„è³‡æ–™å¤¾åç¨±ã€‚                      |
| `services`      | é™£åˆ—   | æ˜¯       |                   | ä¸€å€‹åŒ…å«æ‰€æœ‰å¾…å‚™ä»½æœå‹™çš„åˆ—è¡¨ã€‚                                     |
| `name`          | å­—ä¸²   | æ˜¯       |                   | æœå‹™çš„å”¯ä¸€åç¨±ï¼Œå°‡ä½œç‚ºå£“ç¸®æª”å…§çš„å­è³‡æ–™å¤¾åç¨±ã€‚                     |
| `config_paths`  | é™£åˆ—   | å¦       |                   | ä¸€å€‹åŒ…å«å¤šå€‹ã€Œå–®ä¸€æª”æ¡ˆã€çµ•å°è·¯å¾‘çš„åˆ—è¡¨ã€‚                           |
| `include_dirs`  | é™£åˆ—   | å¦       |                   | ä¸€å€‹åŒ…å«å¤šå€‹ã€Œè³‡æ–™å¤¾ã€çµ•å°è·¯å¾‘çš„åˆ—è¡¨ï¼Œå°‡æœƒéè¿´è¤‡è£½æ•´å€‹è³‡æ–™å¤¾ã€‚     |
| `include_globs` | é™£åˆ—   | å¦       |                   | ä¸€å€‹åŒ…å«å¤šå€‹ Glob æ¨¡å¼çš„åˆ—è¡¨ï¼Œç”¨ä»¥åŒ¹é…æª”æ¡ˆæˆ–è³‡æ–™å¤¾ï¼Œæ”¯æ´ `*` èˆ‡ `**`ã€‚ |

---

## ğŸƒâ€â™€ï¸ å¦‚ä½•åŸ·è¡Œ

æ‚¨å¯ä»¥ç›´æ¥åŸ·è¡Œè…³æœ¬ï¼Œæˆ–åœ¨åŸ·è¡Œæ™‚æŒ‡å®šè¨­å®šæª”è·¯å¾‘ã€‚

*   **ä½¿ç”¨é è¨­è¨­å®šæª” (`/etc/config_backup.yaml`):**
    ```bash
    sudo /usr/local/bin/backup_configs.sh
    ```

*   **æŒ‡å®šè‡ªè¨‚çš„è¨­å®šæª”è·¯å¾‘:**
    ```bash
    sudo /usr/local/bin/backup_configs.sh /path/to/my/custom_config.yaml
    ```

### **åŸ·è¡Œè¼¸å‡ºç¯„ä¾‹**

```[INFO] Backup start: 2025-10-09 18:00:05
[INFO] Using config: /etc/config_backup.yaml
[INFO] Output dir   : /mnt/backup
[INFO] Root in tar  : config_backup
[INFO] >> è™•ç†æœå‹™ï¼škafka
[OK]   file: /etc/kafka/server.properties
[OK]   file: /etc/kafka/zookeeper.properties
[INFO] >> è™•ç†æœå‹™ï¼šnginx
[OK]   file: /etc/nginx/nginx.conf
[OK]   dir : /etc/nginx/conf.d/ (recursive)
[OK]   glob-file: /etc/nginx/sites-enabled/default.conf
[INFO] >> è™•ç†æœå‹™ï¼šmongodb
[OK]   file: /etc/mongod.conf
config_backup/
config_backup/kafka/
config_backup/kafka/server.properties
...
[INFO] å®Œæˆï¼š/mnt/backup/config_backup_2025-10-09_18:00.tar.gz
```

---


## ğŸ—‚ï¸ å£“ç¸®æª”çµæ§‹

åŸ·è¡Œè…³æœ¬å¾Œï¼Œä¸€å€‹æ–°çš„å£“ç¸®æª”æœƒè¢«å»ºç«‹åœ¨æ‚¨æŒ‡å®šçš„ `backup_dir` ä¸­ã€‚è§£å£“ç¸®å¾Œï¼Œå…¶å…§éƒ¨çµæ§‹å¦‚ä¸‹ï¼š

```
<root_dir_name>/
â”œâ”€â”€ <service_one_name>/
â”‚   â”œâ”€â”€ config_file_1.conf
â”‚   â””â”€â”€ some_other_file.properties
â”‚
â”œâ”€â”€ <service_two_name>/
â”‚   â”œâ”€â”€ another_config.yml
â”‚   â””â”€â”€ included_directory/
â”‚       â””â”€â”€ ...
â””â”€â”€ ...
```

**ç¯„ä¾‹:**

æ ¹æ“šå‰è¿°çš„ YAML ç¯„ä¾‹ï¼Œè§£å£“ç¸® `config_backup_2025-10-09_18:00.tar.gz` å¾Œçš„å…§å®¹æœƒæ˜¯ï¼š

```
my_server_configs/
â”œâ”€â”€ kafka/
â”‚   â”œâ”€â”€ server.properties
â”‚   â””â”€â”€ zookeeper.properties
â”œâ”€â”€ mongodb/
â”‚   â””â”€â”€ mongod.conf
â””â”€â”€ nginx/
    â”œâ”€â”€ nginx.conf
    â”œâ”€â”€ conf.d/
    â”‚   â””â”€â”€ default.conf
    â””â”€â”€ sites-enabled/
        â””â”€â”€ default.conf
```

---

## ğŸ§  æç¤ºèˆ‡è…³æœ¬è¡Œç‚º

*   **æ‰¾ä¸åˆ°æª”æ¡ˆ**ï¼šè‹¥ `config_paths` æˆ– `include_dirs` ä¸­å®šç¾©çš„æª”æ¡ˆæˆ–è³‡æ–™å¤¾ä¸å­˜åœ¨ï¼Œè…³æœ¬æœƒå°å‡º `[WARN]` è­¦å‘Šè¨Šæ¯ï¼Œä½†æœƒç¹¼çºŒåŸ·è¡Œï¼Œä¸æœƒä¸­æ–·ã€‚
*   **Glob ç„¡åŒ¹é…**ï¼šè‹¥ `include_globs` ä¸­çš„æ¨¡å¼æ²’æœ‰åŒ¹é…åˆ°ä»»ä½•æª”æ¡ˆï¼Œè…³æœ¬åŒæ¨£æœƒé¡¯ç¤ºè­¦å‘Šä¸¦ç¹¼çºŒåŸ·è¡Œã€‚
*   **æª”åè¡çª**ï¼šå¦‚æœå…©å€‹ä¾†è‡ªä¸åŒè·¯å¾‘çš„æª”æ¡ˆæœ‰ç›¸åŒçš„æª”åï¼ˆä¾‹å¦‚ `/app1/config.yml` å’Œ `/app2/config.yml`ï¼‰ï¼Œè…³æœ¬æœƒè‡ªå‹•å°‡å¾Œè€…çš„æª”åé™„åŠ å…¶ä¾†æºè·¯å¾‘çš„ SHA1 é›œæ¹Šå€¼å‰ 8 ç¢¼ï¼Œä»¥é¿å…æª”æ¡ˆè¢«è¦†è“‹ã€‚
    *   ç¯„ä¾‹ï¼š`config.yml` æœƒè®Šæˆ `config.yml__a1b2c3d4`ã€‚


## Crontab

```
sudo crontab -e
```

```
0 1 * * * 30 1 * * * /usr/local/bin/backup_configs.sh >> /var/log/cleanup.log 2>&1
```
